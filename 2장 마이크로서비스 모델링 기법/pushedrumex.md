# 2. 마이크로 서비스 모델링 방법

## 2.1 뮤직코프 소개
- 가상 시나리오 : 뮤직코프(온라인 CD소매업체)

## 2.2 올바른 마이크로서비스 경계를 만드는 것은 무엇인가?
- 마이크로 서비스는 네트워크 기반의 상호작용이 있지만, 모듈식 분해의 다른 형태
- 마이크로서비스 경계를 구성하는데 필요한 핵심 개념 : 정보 은닉, 응집력, 결합

### 2.2.1 정보 은닉
- 모듈 또는 마이크로서비스 경계 뒤에 가능한 많은 세부 정보를 숨기려는 것
- 장점
    - 향상된 개발 시간: 모듈이 독립적이므로 작업을 병렬로 수행
    - 이해도 : 각 모듈을 따로따로 이해
    - 유연성 : 독립적으로 변경 가능, 모듈을 결합해 새로운 기능 제공

### 2.2.2 응집력
- 관련 있는 행동을 함께 두고, 그렇지 않은 행동은 다른 곳에 두는 것
- 응집셕이 강하면 행동을 변경할 때 한 곳에서만 바꾸고 그 변경을 빠르게 릴리스할 수 있음

### 2.2.3 결합
- 서비스들이 서로 느슨하게 결합됐다면, 한 서비스를 변경할 때 다른 서비스를 변경할 필요가 없음
- 마이크로 서비스의 핵심은 시스템의 다른 부분을 변경하지 않고도 한 서비스를 변경하고 배포할 수 있다는 것
- 결합이 강하다면, 서비스 내부가 변경되면 소비자도 변경해야함

### 2.2.4 결합과 응집력의 연관성
- 응집력이 강하고 결합도가 낮으면 구조가 안정된다
- 응집력은 마이크로서비스 내부에 있는 요소들의 관계에 적용
- 결합은 여러개의 마이크로 서비스 간의 관계를 설명

## 2.3 결합 유형

<img width="548" height="110" alt="스크린샷 2025-10-12 오후 5 05 47" src="https://gist.github.com/user-attachments/assets/1eb485ff-6185-4534-912a-6be081e00d00" />

### 2.3.1 도메인 결합
- 마이크로 서비스가 다른 마이크로서비스와 상호작용 해야하는 상황
- 예시: 뮤직코프의 CD 주문 관리

<img width="601" height="503" alt="image" src="https://gist.github.com/user-attachments/assets/ef8fb244-ff0e-43c7-a4c1-c7893f7239ac" />

    - 주문 처리기는 창고 마이크로 서비스를 호출하여 재고를 예약, 결제 마이크로 서비스를 호출하여 결제 처리
    - 주문 처리기는 창고, 결제 마이크로서비스에 의존하고 결합
    - 창고와 결제 서비스는 결합도가 없음
- 마이크로 서비스 아키텍처에서 도메인 결합 상호작용은 불가피
- 정보 은닉에 맞춰, 꼭 필요한거만 공유하고 최소한의 데이터만을 전송하는 것을 추천

#### 시간적 결합
- 하나의 마이크로 서비스가 작업을 완료하기 위해 동시간에 어떤 작업을 수행하는 다른 마이크로서비스가 필요한 상황
- 예시: 주문 처리기와 창고

<img width="716" height="236" alt="image" src="https://gist.github.com/user-attachments/assets/84f318c2-e890-4964-a6cf-289c153eabf3" />

    - 주문 처리기는 창고 서비스에 동기식 HTTP 호출을 수행
    - 이 때 창고 서비스에 연결할 수 없으면 주문 처리가 불가능
- 해결 방법: 메시지 브로커와 같은 비동기 통신 형태를 사용

### 2.3.2 통과 결합
- 한 마이크로서비스가 다른 마이크로서비스에 데이터를 전달하는 상황
- 예시: 뮤직코프의 주문 처리 방식

<img width="871" height="453" alt="image" src="https://gist.github.com/user-attachments/assets/7dc441a9-e36f-4152-9b12-4882d752aba0" />

    - 주문 처리기는 주문 발송을 준비하기 위해 창고 서비스에 요청. 페이로드: 품목, 배송 목록
    - 창고 서비스는 배송 서비스에 전달. 페이로드: 배송 목록
- 통과 결합의 문제점: 하위 서비스에서 데이터 구조를 변경하면 상위 서비스에 더 큰 변경을 일으킬 수 있음
- 해결방법1: 호출하는 마이크로서비스가 중간자를 우회하는 시도가 합당한지 고려
    - 주문 처리기가 배송 서비스와 직접 통신
- 해결방법2: 하위 수준의 세부 사항을 숨김
    - 창고 서비스가 주문 처리기로부터 필요한 (가공되지 않은)정보를 받고, 로컬에서 배송 목록을 만들어서 배송 서비스에 요청
    - 배송 서비스의 데이터 구조가 변경되도 주문 처리기는 변경하지 않아도 됨
- 해결방법3: 창고가 배송 목록 자체의 구조를 전혀 알지 못하게 하는 것.
    - 주문 처리기가 배송 목록을  전송하지만 창고 서비스는 필드를 조회하거나 처리하지 못하게 하는 것
    - 배송 목록 데이터 구조가 변경되면 주문, 배송 서비스는 변경해야하지만 창고 서비스는 데이터를 그대로 전달만하기 때문에 변경할 필요가 없음

### 2.3.3 공통 결합
- 둘 이상의 마이크로서비스가 공통 데이터 집합을 사용할 때 발생
- 동일한 공유 데이터베이스를 여러 마이크로서비스가 사용하는 경우
    - 데이터 구조가 변경되면 한 번에 여러 마이크로서비스에 영향을 미침
- 예시: 주문 처리기와 창고 서비스가 공유된 주문 테이블을 사용

<img width="902" height="467" alt="image" src="https://gist.github.com/user-attachments/assets/7ca34e79-47b4-4ee6-b77c-cc706f5858e8" />

    - 상태 기계: 상태가 올바른 방식으로 변경되는 지 확인하는 방법
    - 문제점: 창고 서비스와 주문 처리기가 상태 기계를 관리하는 책임을 공유
    - 잠재적인 해결 방법: 하나의 마이크로 서비스에서만 주문 상태를 관리, 다른 서비스는 주문 상태 변경 요청

### 2.3.4 내용 결합
- 상위 서비스가 하위 서비스의 내부까지 도달해 서비스의 내부 상태를 변경하는 상황
- 예시: 주문 상태를 관리하는 주문 서비스가 존재할 때, 창고 서비스가 주문 데이터가 저장된 테이블에 직접 접근하여 업데이트
    - 이 경우 주문 상태가 정상적으로 관리될 수 없음

## 2.4 딱 도메인 주도 설계만큼
- 마이크로서비스의 경계를 정하는 기본 메커니즘은 DDD를 기반으로 도메인 자체를 중심으로 진행
- DDD의 핵심 개념: 보편 언어, 애그리거트, 경계 콘텍스트

### 2.4.1 보편 언어
- 의사소통을 돕기 위해 코드와 도메인 설명에 사용할 공통 언어를 정의하고 채택
- 사용자가 쓰는 용어를 코드에 동일하게 사용하는 것을 추천

### 2.4.2 애그리거트
- 객체들의 집합
- 하나의 마이크로서비스는 하나 이상의 애그리거트에 대한 생명 주기와 데이터 저장소를 처리
- 애그리거트 같의 관계가 존재할 때, 하나의 마이크로서비스 범위 내에 존재하면 외래키를 사용하여 저장
- 애그리거트 같의 관계가 존재할 때,여러 마이크로 서비스이 걸쳐 존재한다면 관계를 모델링할 방법이 필요
    - ID를 통해 다른 마이크로서비스에 요청을 보내 관계성있는 데이터를 조회

### 2.4.3 경계 콘텍스트
- 비지니스 도메인 내부의 명시적인 경계
- 경계 콘텍스트는 구현 세부 사항을 숨김

### 2.4.4 애그리거트와 경계 콘텍스트를 마이크로서비스에 매핑
- 서비스를 더 작은 서비스로 분해할 경우, 애그리거트 자체의 분리하지 않아야함
- 하나의 마이크로 서비스에서 여러 애그리거트를 관리할 수 있지만, 하나의 애그리거트가 둘 이상의 마이크로서비스에서 관리되는 상황은 지양해야함

#### 거북이 아래 거북이
- 경계 콘텍스트는 여러개의 경계 콘텍스트를 포함할 수 있음
- 서비스를 더 작은 부분으로 분해하는 것은 내부 구현이므로 숨기는 것이 좋음
    - 예시: 창고 서비스를 재고와 배송으로 분리했지만, 외부에서 볼때는 여전히 창고 마이크로 서비스만 존재
    - 정보 은닉의 한 형태로, 구현 세부 사항이 변경되도 소비자는 알 필요가 없음

### 2.4.5 이벤트 스토밍
- 기술 전문가와 비전문가가 다같이 참여하여 도메인 모델에 대한 표현을 찾는 작업
- 시스템에서 발생하는 일(도메인 이벤트), 이벤트를 발생시키는 사용자의 행동, 애그리거트를 정의

## 2.5 마이크로서비스를 위한 도메인 주도 설계

### msa에서 DDD를 사용할 경우 유용한점
- 경계 컨텍스트가 정보 은닉에 도움이 된다.
- 보편언어를 사용함으로써 msa 엔드포인트를 정의할 때 도움이 된다.
- 경계 콘텍스트에 따라 시스템이 분해될 경우, 변경 사항이 하나의 msa 경계로 한정될 가능성이 높다.

## 2.6 비즈니스 도메인 경계에 대한 대안
- msa 경계를 찾을 때 고려할 수 있는 요소
    - 변동성: 변동성에 기반하여 분해를 한다면 빈번하게 변경되는 부분을 자체 서비스로 추출하여 효과적으로 작업이 가능
    - 데이터: 관리되는 데이터의 특징에 따라 다양한 형태의 분해가 발생. 다양한 개인정보 및 보안 문제로 인해 데이터 분리를 해야하는 경우가 많음
    - 기술: 다른 기술를 사용해야할 경우 ex) 기능의 일부를 Rust와 같은 언어로 구현
    - 조직: 조직을 어떻게 구성하느냐에 따라 msa를 분리해야하는 상황이 발생할 수 있음

## 2.7 혼합 모델과 예외
- 정보 은닉, 느슨한 결합, 응집력 강화에 중점을 둔다면 도메인 주도 아키텍처가 될 가능성이 높아짐
- 하지만 경우에 따라 여러 모델을 혼합해야할 경우도 있음
