# 7 빌드

## 7.1 지속적 통합(CI)에 대한 간략한 소개
- CI(Continuous Integration)의 핵심 목표는 모든 사람이 자주, 안전하게 코드 변경을 통합하는 것
- 새로 커밋된 코드가 기존 코드와 문제 없이 잘 통합되는지 빈번하게 검증
- CI 서버의 주요 역할
    - 코드 커밋 감지
    - 컴파일 및 테스트 실행
    - 빌드 성공/실패에 대한 빠른 피드백 제공
- CI의 장점
    - 빠른 코드 품질 피드백
    - 테스트 및 정적 분석 자동화
    - 산출물과 코드 간 추적 가능

### 7.1.1 실제로 CI를 하고 있는가?
- CI 도구를 사용한다고 해서 CI를 제대로 하고 있는 것은 아님
- CI를 제대로 수행하고 있는지 판단하기 위한 3가지 질문

#### 1. 메인 라인에 하루에 한 번 이상 체크인하는가?
- 통합을 자주 하지 않으면 나중에 머지가 매우 어려워짐
- 기능 브랜치를 쓰더라도 짧게 유지하고 자주 메인에 병합해야 함

#### 2. 변경 사항을 검증하는 자동 테스트가 있는가?
- 테스트가 없다면 “컴파일만 되는 코드”일 뿐
- 동작이 깨졌는지 확인할 수 없다면 CI가 아님

#### 3. 빌드 실패가 팀의 최우선 과제인가?
- 빌드가 깨졌다면 다른 작업을 중단하고 즉시 복구
- 실패한 상태로 커밋이 쌓일수록 복구 비용이 증가

### 7.1.2 브랜치 모델
- 기능 브랜치는 통합을 늦추는 문제가 있음
- 변경 사항을 오래 분리할수록 머지 시점의 충돌이 커짐
- 대안: 트렁크 기반 개발
    - 모두 동일한 메인 브랜치에서 작업
    - 미완성 기능은 기능 플래그로 숨김
- 핵심 원칙
    - 일찍 통합하고 자주 통합
    - 장기 브랜치는 지양
- DORA 연구 결과
    - 짧은 수명의 브랜치
    - 작은 변경 단위
    - 자주 머지하는 팀이 더 높은 성과를 냄

## 7.2 빌드 파이프라인과 지속적 제공
- 모든 테스트를 한 번에 실행하면 빠른 실패에 대한 피드백이 늦어짐
- 해결책: 빌드 파이프라인
    - 컴파일과 빠른 테스트 -> 느린 테스트 -> 성능 테스트 -> 운영 환경
- 각 단계는 이전 단계를 통과해야 다음 단계로 이동
- 동일한 산출물을 파이프라인 전체에서 재사용
- 이를 통해 운영 환경에서도 동작할 가능성에 대한 신뢰 확보

### 7.2.1 도구
- CI 도구를 고쳐 CD 도구로 확장하는 것보다 CD 를 지원하는 도구를 사요하는 것을 추천
- 일부 단계는 수동으로 해야할 수도 있어 CD 도구를 사용해 모델링할 수 있어야 함

### 7.2.2 절충점과 환경
- 파이프라인 앞단
    - 빠른 피드백이 목적
    - 운영 환경과는 차이가 있음
- 파이프라인 뒷단
    - 운영 환경과 유사
    - 느리고 비용이 큼
- 핵심 과제
    - 빠른 피드백과 운영 환경 유사성 사이의 균형

### 7.2.3 산출물 생성
- 산출물 생성의 핵심 원칙
    1. 산출물은 한 번만 빌드
    2. 테스트한 산출물을 그대로 배포
- 동일한 산출물을 모든 환경에서 재사용
- 환경별 설정은 산출물 내부가 아닌 외부 설정으로 관리

## 7.3 소스 코드와 빌드를 마이크로서비스에 매핑하기

### 7.3.1 거대한 리포지터리 하나와 거대한 빌드
- 모든 마이크로서비스 코드를 하나의 리포지터리에서 관리
- 한 서비스 변경에도 모든 서비스가 빌드됨
- 단점
    - 불필요한 빌드 증가
    - 배포 대상 판단이 어려움
    - 빌드 실패 시 전체 작업 중단
- 초기 소규모 팀에서만 제한적으로 적합

### 7.3.2 마이크로서비스당 하나의 리포지터리 (멀티레포)
- 서비스 단위로 리포지터리 분리
- 장점
    - 명확한 소유권
    - 독립적인 빌드와 배포
- 단점
    - 여러 서비스에 걸친 변경이 어려움
- 서비스 경계를 자주 넘는 변경이 있다면 구조 재검토 필요

### 7.3.3 모노레포
- 여러 마이크로서비스 코드를 하나의 리포지터리에 관리
- 장점
    - 여러 서비스에 대한 원자적 커밋 가능
- 단점
    - 빌드 및 소유권 관리 복잡
    - 대규모 도구 투자 필요
- 주의
    - 원자적 커밋 ≠ 원자적 배포

### 7.3.4 어떤 방식을 선택해야 하는가?
- 필자의 결론
    - 대부분의 경우 멀티레포가 더 단순하고 안전
- 모노레포는 조직이 성장할수록 전환 비용과 복잡성이 급격히 증가
- 서비스 경계를 자주 넘는 변경이 많다면 구조를 재검토해야 함
