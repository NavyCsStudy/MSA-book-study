## 1. 분열, 공황 그리고 혼란

- msa 에서는 모니터링할 서버는 여러 대, 선별할 로그 파일도 여러 개, 네트워크 지연으로 문제가 발생할 수 있는 장소도 여러 곳.
- 작은 것을 모니터링하고 큰 그림을 볼 수 있도록 집계를 제공해야 함.
- 분석을 위해 데이터를 조각으로 나누는 도구가 필요.
- 운영 환경 테스트라는 개념을 수용해 시스템의 정상 상태를 정의할 수 있는 사고 방식이 필요.

## 2. 단일 마이크로서비스, 단일 서버

- 문제 상황을 대비하기 위해 무엇을 찾아야 하는가?

<img width="303" height="249" alt="image" src="https://github.com/user-attachments/assets/f193c04b-6f49-4558-bb2e-a3dc2500f1ed" />

- 호스트 자체의 정보: cpu, 메모리 등
- 인스턴스가 출력하는 로그
- 응답 시간 모니터링
- 헬스 체크 api

## 3. 단일 마이크로서비스, 다수 서버

- 이제 문제가 좀 더 까다로워짐.
- 높은 cpu 사용률이 모든 호스트에서 나타나는지, 단일 호스트에서만 나타나는지, 혹은 서비스 자체에 문제가 있는 것인지 파악해야 함.

<img width="540" height="343" alt="image" src="https://github.com/user-attachments/assets/0812ec7c-9a21-4f49-91ba-c39b06d1290d" />

- 여전히 호스트 수준의 메트릭(metrics)을 추적할 수 있음.
- 그러나 모든 호스트에 걸쳐져 있는 것들을 확인하려면 메트릭을 수집하고 분석할 수 있는 도구가 필요. 아직은 로그를 이용해서 문제를 파악할 수 있는 단계.
- 응답 시간 추적은 로드밸런서에서 수집.
- 비정상 노드가 있으면 제거해야하기 때문에 헬스 체크에 대해 더 많은 관심이 필요.

## 4. 다수 마이크로서비스, 다수 서버

- 이 시점부터 엄청난 양의 메트릭과 로그를 선별하고 이해하려는 노력이 필요.
- 정적인 모니터링 환경에서 적극적인 옵저버빌리티(관찰가능성)과 운영 환경 테스트 사고 방식이 필요.

<img width="638" height="637" alt="image" src="https://github.com/user-attachments/assets/6cde2356-9551-4b0c-b82e-7d20ccd659db" />

## 5. 관찰가능성 대 모니터링

- 옵저버빌리티(observability)는 외부 출력으로부터 시스템의 내부 상태를 이해할 수 있는 수준을 의미함.
- sw를 서로 다른 개체의 집합이 아닌 시스템으로 본다는 개념이 중요함.
- 우리는 시스템을 모니터링하지만 모니터링으로부터 무엇을 할지를 잊어서는 안 됨.
- 분산 시스템에서는 전통적인 모니터링 경고 메커니즘으로는 예측할 수 없는 문제가 발생함.
- 관측 가능한 시스템을 가게 되면, 이전에는 불가능했던 다양한 질문을 할 수 있음.

### 5.1 관찰가능성의 주축? 그다지 빠르지 않다

- 관찰가능성은 속성. 속성을 얻을 수 있는 방법에는 여러 가지가 있으며, 특정 구현 세부사항에 메달려서는 안 됨.
- 로그, 메트릭과 같은 개념에는 명확한 경계가 없으며 서로 섞일 수 있음.
- 시스템을 관찰 가능하게 만들 때는 수집, 조사할 수 있는 출력에 무엇이 있을지 생각할 것.

## 6. 관찰가능성의 구성 요소

#### 로그 집계

- 여러 ms에서 정보를 수집하는 것.
- 모든 모니터링이나 옵저버빌리티 솔루션의 중요한 구성 요소.

#### 메트릭 집계

- ms와 인프라의 원시 수치를 캡처해 문제를 탐지.
- 용량 계획을 세우고, 애플리케이션 확장에 활용 가능.

#### 분산 추적

- 잘못된 것을 파악하고 정확한 지연 시간 정보를 기록하기 위해 여러 ms 경계에서 호출 흐름을 추적.

#### 지금 괜찮은가?

- 예산, sla, slo 등을 살펴보고 ms가 소비자 요구 사항을 충족하는지 확인하는 과정의 일부로 사용할 수 있는 방법을 확인.

#### 알림

- 어떤 것을 알려야할지에 대한 고민이 필요.

#### 시맨틱 모니터링

- 시스템 상태가 어떠한 상황에 놓여있는지에 대한 정의.

#### 운영 환경에서 테스트

- 운영 환경의 다양한 테스트 기법에 대한 요약.

### 6.1 로그 집계

- msa 에서는 로그를 검색 가능한 것으로는 부족함. 특정 시스템을 사용해 로그를 수집, 중앙에서 사용할 수 있도록 관리가 필요.

<img width="760" height="313" alt="image" src="https://github.com/user-attachments/assets/5e1c7ce3-3718-4724-8a11-142f0793ff96" />

- 로그 집계는 유용함. 특히 상관관계 ID와 함께 사용될 때 가치가 더욱 높아짐.
- 로그 집계 구현은 다른 것들에 비해 어렵지 않음. 따라서 초기에 운영 상태를 테스트하는 방법으로 사용할만 함.
- 물론 한계가 존재하지만 초기에 쉽게 시작할 수 있음.

#### 공통 포맷

- 로그 집계시에는 로그를 대상으로 쿼리를 실행해 유용한 정보를 추출할 수 있어야 함.
- 날짜, 시간, ms의 이름, 로그 레벨 등이 일관된 위치에 있어야 함.
- 일부 로그 전달 에이전트는 로그를 다시 포매팅하는 기응을 제공하지만 그만큼 리소스를 점유. 레거시 시스템과 같이 손대기 어려운 곳에는 유용할 수 있음.

<img width="745" height="120" alt="image" src="https://github.com/user-attachments/assets/01889a17-6749-4505-ab81-34b372041d89" />

- 로그 집계 도구는 위와 같이 일관된 문자열을 구문 분석하는 방법을 알아야 함.
- 그러나 고객 id 같은 문자열은 찾는 것은 쉽지 않을 것.
- 고객 id 역시 일관된 위치에서 찾을 수 있도록 json 포맷을 사용할 수 있음. 그러나 적절한 로그 집계 도구가 준비되어 있지 않다면 일반 텍스트 뷰어로는 읽기 어려워짐.

#### 로그 문자열의 상관관계

- msa 환경에서 발생한 오류는 어떻게 로그를 이용해 규명할 수 있는가?

<img width="738" height="474" alt="image" src="https://github.com/user-attachments/assets/e46a3ad0-9222-4be5-ab07-2688ba218195" />

- 유용한 해결책은 상관관계 id
- 첫 번째 호출 이후 관련된 모든 후속 호출을 연관시키는데 사용할 고유 id. 위 예에서는 게이트웨이에서 id를 생성하고 모든 후속 호출에 해당 id를 매개변수로 전달.

<img width="759" height="191" alt="image" src="https://github.com/user-attachments/assets/f437f7ad-2ec8-45e3-a2c6-3007da27947f" />

- 문제가 발생했을 때, 상관관계 id를 이요하여 연관된 로그를 쉽게 추출할 수 있음.

<img width="632" height="472" alt="image" src="https://github.com/user-attachments/assets/90ee832f-a993-4b14-b56a-efaf7bad014d" />

- 이벤트 폭풍 또는 지엽적인 사례를 추적하거나 호출 전 단계를 확인하기 쉬워짐. 비용이 많이 드는 트랜잭션을 식별하는 데 유용.
- 이미 운영중인 시스템에 상관관계 id를 도입하는 것은 어려움. 로그 집계가 있다면 가능한 한 빠르게 상관관계 id를 구현하는 것이 좋음.

#### 타이밍

- 로그에 남아있는 타임스탬프는 완전히 신뢰할 수 없음.
- 각각의 인스턴스의 시계가 동기화되어 있다고 보장할 수 없음. 로그만 봤을 때는 먼저 실행된 것처럼 보이는 기능이 사실은 나중에 실행된 것일 수 있음.
- NTP(Network Time Protocol) 같이 시간 오차를 줄이는 프로토콜이 있지만 오차를 줄일 뿐 인스턴간에 시간이 동기화되지는 않음.
- 즉, 로그에 기록된 시간은 호출 흐름에 대한 정확한 타이밍 정보를 얻을 수 없으며, 인과 관계를 이해하는 데 사용할 수 없음.

#### 구현

- 대표적인 것은 elk. 이미 다른 목적으로 엘라스틱서치를 사용하고 있다면 새로 도입하는 부담을 줄일 수 있음.
- 엘라스틱서치가 오픈 소스에서 상용 제품으로 점 등에서 aws 클라우드워치 같은 클라우드 공급자의 솔루션 등 다양한 대안이 있음.

#### 단점

- 첫째. 시간 왜곡으로 인해 로그 순서를 완전히 신뢰할 수 없음.
- 둘째. 호출 수에 따라 엄청난 양의 데이터가 생겨남. 집계 도구는 로그의 인덱스를 생성하는 과정에서 그만큼의 비용이 발생할 수 있음. 도구에 따라서는 로깅 기간을 제한하고 있어서 별도의 저장소로 로그 데이터를 옮겨야 함.
- 셋째. 로그에 민감 정보가 포함되는 경우 액세스 권한을 관리해야 하거나, 공격의 대상이 될 수 있음.

### 6.2 메트릭 집계

- 복잡한 시스템에서 어떤 상태를 **정상**으로 취급할지 알기 어려움.
- 이를 해결하는 방법은 충분히 오랜 시간 동안 시스템이 어떻게 작동하는지에 대한 **메트릭(지표)**를 수집하는 것.
- 분산 환경에서는 빈번하게 프로비저닝하므로 새로운 호스트에서 메트릭을 쉽게 수집하는 시스템이 필요함.
- 메트릭 집계를 통해 용량 계획(capacity planning)에 대한 이점을 얻을 수 있음. 우리 서비스의 요구를 충족하는 인프라를 구성할 수 있음.

#### 낮은 카디널리티 대 높은 카디널리티

- 많은 도구는 카디널리티가 높은 데이터를 저장하고 검색하도록 만들어짐.
- 다만 카디널리티가 높을 수록 그만큼 저장되는 데이터양도 증가함.

#### 구현

- 카디널리티가 낮은 데이터를 처리하도록 구축된 시스템은 높은 카디널리티의 데이터를 처리하기 어려움.
- 프로메테우스는 훌륭하지만 높은 카디널리티의 데이터를 처리하기에는 적합하지 않음. 다양한 도구들을 고려해 볼 것.

### 6.3 분산 추적

- 복잡한 시스템에서 서로 다른 데이터를 가져와 연관된 호출을 함께 볼 수 있는 것은 중요함.

#### 작동 원리

- 스레드 안의 로컬 활동은 스판(span)으로 캡쳐됨.
- 각 스판은 고유한 식별자로 연결되며 하나의 트레이스(trace)로 구성되어 중앙 수집기로 전송.

<img width="755" height="488" alt="image" src="https://github.com/user-attachments/assets/74aa06f8-22f6-4864-bac6-ae4c98eaa81c" />

- 스판에는 시작, 종료 시간, 연관된 로그, 임의이 키-값 쌍들이 포함됨.
- 이러한 정보 수집은 시스템에 직접적이 영향을 미칠 수 있기 때문에 올바른 정보만 수집하는 샘플링이 중요함.

#### 분산 추적 구현

- 오픈텔레메트리 api와 같은 표준을 사용하는 경우 일부 프레임워크는 이러한 api를 기본적으로 지원하며, 이미 유용한 정보를 전송.
- 스판 정보를 수집기로 전달하는 역할은 일반적으로 로컬 에이전트가 수행. 로컬 에이전트를 통해 전송되는 정보를 효과적으로 버퍼링할 수 있음.
- 그리고 모든 정보를 처리할 수 있는 정보 수집기가 필요.

### 6.4 잘하고 있나요?

- 점점 복잡해지는 시스템에서 어떤 상태를 정상이라고 말해야 하는가?
- 사이트 안정성 엔지니어링(sre)는 이러한 분야에서 많은 작업을 수행 중.

#### 서비스 수준 계약

- 서비스 수준 계약(service-level aggrement, sla)은 시스템을 구축하는 사람과 사용하는 사람 사이의 계약.
- 사용자가 기대하는 것, 시스템이 허용 가능한 동작 수준에 도달하지 못할 경우 발생하는 상황을 설명.
- sla는 최소한의 수준으로 정하는 경향이 많아 시스템이 목표치를 달성한 경우에도 최종 사용자는 만족하지 못하느 경우가 많음.

#### 서비스 수준 목표

- 서비스 수준 목표(service-level objective, slo)는 팀이 제공하기로 계약한 것을 정의.
- 조직 내 모든 팀이 slo를 달성하면 조직의 sla 요구 사항을 충족할 수 있음.
- so는 sla에 설명되지 않는 다른 목표를 정하기도 함. 팀이 내부적으로 원하는 목표 같은 것들.

#### 서비스 수준 지표

- 서비스 수준 지표(service-level indicator, sli)는 우리 sw가 수행하는 작업의 척도. slo를 충족하는지 확인하기 위한 데이터.
- 특정 프로세스의 응답 시간, 등록 중인 고객 등.

#### 오류 예산

- 오류 예산(erro budget)은 시스템에서 허용되는 오류의 양을 명확하게 하는 것.
- slo를 얼마나 잘 달성하고 있는지 파악하는데 도움이 되며, 어떤 위험을 감수해야 하는지 더 합리적으로 결정할 수 있음.

### 6.5 알림

#### 어떤 문제는 다른 문제보다 훨씬 더 심각하다

- 잠재적인 문제 요인이 증가함에 따라 우선순위를 잘 지정해야 함.

#### 알림 피로

- 너무 많은 알림은 우리가 어떤 것을 할지 파악하는데 도움을 주지 못할 수 있음.

#### 더 나은 알림을 위해

- 좋은 알림을 만드는 데 유용한 속성.
  - 관련성
  - 고유성
  - 적시성
  - 우선순위
  - 알기 쉬움
  - 진단
  - 자문(운영자가 취해야 할 조치를 이해하도록 도와야 함)
  - 집중
 
### 6.6 시맨틱 모니터링

- 시스템의 허용 가능한 시맨틱(의미론)에 대한 모델을 정의하는 것.
- 이를 위해 오류를 찾는 것보다는 시스템이 기대하는 대로 동작하고 있는가 질문해야 함.
- 시스템 동작이 모델을 충족하는지는 다음과 같은 방법으로 확인 가능.

#### 실사용자 모니터링

- 운영 시스템에서 실제로 발생하는 상황을 살펴보고 모델과 비교.
- 이 방법은 필요한 정보를 적시에 사용하지 못하는 경우가 많음. 이미 발생한 일을 알려주므로 문제가 발생한 후에 문제를 파악할 수 있음.

### 6.7 운영 환경에서 테스팅

- 모니터링 활동의 한 형태.

#### 합성 트랜잭션

- 가짜 사용자 행동을 운영 환경 시스템에 주입하는 것.
- 저수준 메트릭에 대해 경고하는 것보다 시스템 문제를 잘 보여줄 수 있음. 그러나 합성 트랜잭션이 실패하는 경우 그 이유를 알아내기 위해서는 여전히 저수준의 상세 정보가 필요.

#### A/B 테스트

- 동일한 기능의 다른 두 버전을 배포해 어떤 버전의 기능이 더 잘 수행되는지 체크하는 것.

#### 카나리아 릴리스

- 일부 사용자 그룹에게 새로운 기능의 릴리스를 보여주는 것.
- 문제가 발생하면 롤백하여 해결 가능.

#### 병렬 실행

- 동일한 기능의 동등한 구현을 나란히 실행하는 것.
- 서로 다른 두 버전을 부하 특성과 같은 측면을 더 잘 이해할 수 있음.

#### 스모크 테스트

- 운영 환경 출시 전에 잘 작동하는지 확인하는 것.
- 간단한 활동부터 합성 트랜잭션까지 다양함.

#### 합성 트랜잭션

- 가짜 사용자 상호작용을 시스템에 주입하는 것.

#### 카오스 엔지니어링

- 운영 시스템에 결함을 주입하는 것.

## 7. 표준화

- 로그, 메트릭을 수집하면서 여러 서비스에서 동일한 의미가 서로 다른 이름을 가지고 있다면 곤란할 것.

## 8. 도구 선택

### 8.1 민주적 선택

- 숙련자만 다룰 수 있는 어려운 도구, 비싼 도구는 곤란함.
- sw 공동 소유 모델을 위해서는 모든 사람이 sw를 잘 사용할 수 있어야 함.

#### 8.2 쉬운 통합

- 오픈텔레메트리 와 같은 표준을 이용하면 통합이 쉬워지고, 솔루션을 쉽게 변경할 수 있음.

#### 8.3 맥락 제공

- 정보를 살펴볼때 도움이 되려면 많은 맥락을 제공하는 도구가 필요.
- 다음과 같이 분류할 수 있을 것.
  - 시간적 맥락
  - 상대적 맥락
  - 관계적 맥락(이것에 의존하는 것이 있는가?)
  - 비례적 맥락(얼마나 나쁜가, 범위는 크거나 작은가?)

#### 8.4 실시간

- 문제를 발견하기 위해서는 충분히 신속한 정보가 필요함.

#### 8.5 규모에 맞게

- 규모가 작은 시스템에서 복잡한 솔루션을 필요하지 않음.
- 이상적인 것은 규모에 따라 확장할 수 있는 도구.

## 9. 기계화된 전문가

- 자동으로 이상을 감지하는 기능은 계속해서 개선되고 있음.
- 근본적으로는 우리의 의사 결정을 위해 전문 지식이 필요함.

## 10. 시작하기

- 우선 호스트에 대한 기본 정보를 캡처. 호출의 응답 시간을 로그에 기록하고, 상관관계 id를 로그에 삽입.
- 이를 위해 최소한 기본적인 메트릭, 로그 집계 툴체인이 있어야 함.
- 주요 연산의 경우 합성 트랜잭션으로 잘 작동하는지 확인.
- 시간이 지나면서 더 많은 정보를 수집하고 도구를 개선해 플랫폼의 옵저버빌리티를 개선해나가야 함.
